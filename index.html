<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¹ä¹ã‚Œã‚“ã—ã‚…ã†ï¼ˆæ­Œãƒ¢ãƒ¼ãƒ‰ï¼‰</title>
  <style>
    :root{ --bg:#0b1020; --card:#111933; --acc:#4fa3ff; --ok:#22c55e; --bad:#ef4444; --text:#e9eefb; }
    *{box-sizing:border-box}
    body{margin:0;padding:16px 16px 40px;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN","Noto Sans JP",sans-serif}
    .container{max-width:980px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:clamp(20px,4vw,28px);margin:0}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.05),transparent 30%) ,var(--card);border:1px solid rgba(255,255,255,.08);padding:16px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{font-size:14px;opacity:.9}
    select,button,input[type="number"],input[type="text"]{background:#0b1430;color:var(--text);border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:10px 12px;font-size:16px}
    button{cursor:pointer}
    button.primary{background:var(--acc);border-color:transparent;color:#001326;font-weight:700}
    button.ghost{background:transparent}
    button.lg{font-size:20px;padding:12px 16px;border-radius:14px}
    .controls{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.controls{grid-template-columns:1.2fr 1fr .8fr 1.1fr}}
    .problem{display:flex;align-items:center;justify-content:center;gap:12px;font-weight:800;font-size:clamp(22px,7vw,56px);min-height:96px}
    .answerWrap{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px}
    .answerWrap input{font-size:clamp(20px,5vw,36px);width:8ch;text-align:center}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.15);border-radius:999px;padding:6px 10px;font-size:13px;opacity:.9}
    .status{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .bar{height:10px;background:#0b1430;border-radius:999px;overflow:hidden}
    .bar .fill{height:100%;background:linear-gradient(90deg,var(--acc),#8ef0ff);width:0%}
    .result{margin-top:12px;font-size:16px}
    .grid9{display:grid;grid-template-columns:repeat(9,1fr);gap:6px;margin-top:10px}
    .chip{background:#0b1430;border:1px solid rgba(255,255,255,.15);padding:8px;border-radius:10px;text-align:center}
    .chip.done{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.5)}
    .chip.miss{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.5)}
    .hint{opacity:.8;font-size:13px}
    .sr{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
  .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;max-width:360px;margin:16px auto}
.keypad button{padding:20px 0;font-size:1.4em;border-radius:14px}
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ä¹ä¹ã‚Œã‚“ã—ã‚…ã† <span class="pill">ğŸµ æ­Œãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ</span></h1>
      <div>
        <button class="ghost" id="btnHelp" aria-label="ä½¿ã„æ–¹">â“ ã¤ã‹ã„ã‹ãŸ</button>
      </div>
    </header>

    <section class="card controls" aria-label="è¨­å®š">
      <div class="row" style="align-items:end">
        <div>
          <label for="mode">ãƒ¢ãƒ¼ãƒ‰</label><br>
          <select id="mode" aria-label="å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰">
            <option value="sequential">ã˜ã‚…ã‚“ã°ã‚“</option>
            <option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option>
          </select>
        </div>
        <div>
          <label for="dan">ã ã‚“</label><br>
          <select id="dan" aria-label="é¸ã¶ã ã‚“">
            <option value="all">ãœã‚“ã¶(1ã€œ9Ã—1ã€œ9)</option>
            <option value="1">1ã®ã ã‚“</option>
            <option value="2">2ã®ã ã‚“</option>
            <option value="3">3ã®ã ã‚“</option>
            <option value="4">4ã®ã ã‚“</option>
            <option value="5">5ã®ã ã‚“</option>
            <option value="6">6ã®ã ã‚“</option>
            <option value="7">7ã®ã ã‚“</option>
            <option value="8">8ã®ã ã‚“</option>
            <option value="9">9ã®ã ã‚“</option>
          </select>
        </div>
        <div>
          <label for="readMode">ã‚ˆã¿ã‚ã’</label><br>
          <select id="readMode" aria-label="ã‚ˆã¿ã‚ã’è¨­å®š">
            <option value="off">ãŠãµ</option>
            <option value="on">å•é¡Œã‚’ã‚ˆã‚€</option>
            <option value="song">ä¹ä¹ã®ã†ãŸ</option>
          </select>
        </div>
        <div class="row">
          <button id="btnStart" class="primary lg" aria-label="ã‚¹ã‚¿ãƒ¼ãƒˆ">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          <button id="btnSpeak" class="lg" aria-label="å•é¡Œã‚’ã‚ˆã¿ã‚ã’">ğŸ—£ï¸ ã‚ˆã¿ã‚ã’</button>
          <button id="btnSingDan" class="lg" aria-label="ã ã‚“ã‚’æ­Œã†">ğŸµ ã ã‚“ã‚’æ­Œã†</button>
        </div>
      </div>

      <div class="status" style="margin-top:6px">
        <div class="pill" id="pillInfo">å•é¡Œæ•°: <span id="total">0</span> / æ­£è§£: <span id="correct">0</span> / ã¾ã¡ãŒã„: <span id="wrong">0</span> / é€£ç¶šæ­£è§£: <span id="streak">0</span></div>
        <div class="pill">ãƒ™ã‚¹ãƒˆã‚Œã‚“ãã: <span id="best">0</span></div>
      </div>
      <div class="bar" aria-hidden="true"><div class="fill" id="progress"></div></div>
    </section>

    <section class="card" style="margin-top:14px">
      <div id="problem" class="problem" aria-live="polite" aria-atomic="true">ã‚¹ã‚¿ãƒ¼ãƒˆã‚’ãŠã—ã¦ã­</div>
      <div class="answerWrap">
        <label class="sr" for="answer">ã“ãŸãˆ</label>
        <input id="answer" type="text" inputmode="none" placeholder="ã“ãŸãˆ" readonly disabled />
        <button id="btnSubmit" class="primary" disabled>ã“ãŸãˆã‚‹</button>
        <button id="btnNext" disabled>ã¤ãã¸ â–¶</button>
      </div>
      <div id="keypad" class="keypad" role="group" aria-label="æ•°å­—ã‚­ãƒ¼">
        <button data-digit="1">1</button>
        <button data-digit="2">2</button>
        <button data-digit="3">3</button>
        <button data-digit="4">4</button>
        <button data-digit="5">5</button>
        <button data-digit="6">6</button>
        <button data-digit="7">7</button>
        <button data-digit="8">8</button>
        <button data-digit="9">9</button>
        <button data-action="clear">ã‚¯ãƒªã‚¢</button>
        <button data-digit="0">0</button>
        <button data-action="back">âŒ«</button>
      </div>
      <div id="feedback" class="result" aria-live="polite"></div>
      <div id="board" class="grid9" aria-label="é€²ã¿å…·åˆ"></div>
      <p class="hint">Enterã‚­ãƒ¼ã§ã“ãŸãˆ / Spaceã§æ¬¡ã¸ã€‚ã‚¹ãƒãƒ›ã¯æ•°å­—ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒå‡ºã¾ã™ã€‚</p>
    </section>
  </div>

  <dialog id="dlgHelp">
    <form method="dialog" style="max-width:680px">
      <h3>ã¤ã‹ã„ã‹ãŸ</h3>
      <ol>
        <li>ãƒ¢ãƒ¼ãƒ‰ã¨ã€Œã ã‚“ã€ã‚’ãˆã‚‰ã‚“ã§ <b>ã‚¹ã‚¿ãƒ¼ãƒˆ</b>ã€‚</li>
        <li>ã“ãŸãˆã‚’å…¥ã‚Œã¦ <b>ã“ãŸãˆã‚‹</b>ã€‚æ­£è§£ãªã‚‰è‡ªå‹•ã§æ¬¡ã¸ã€‚</li>
        <li><b>ğŸ—£ï¸ ã‚ˆã¿ã‚ã’</b>: ã€Œå•é¡Œã‚’ã‚ˆã‚€ã€ã‹ã€Œä¹ä¹ã®ã†ãŸã€ã‚’é¸ã¹ã¾ã™ã€‚<br>ã€Œã ã‚“ã‚’æ­Œã†ã€ã¯é¸ã‚“ã ã ã‚“ï¼ˆ2ã®ã ã‚“ãªã©ï¼‰ã‚’æœ€åˆã‹ã‚‰ã•ã„ã”ã¾ã§æ­Œã„ã¾ã™ã€‚</li>
      </ol>
      <p>ãƒ™ã‚¹ãƒˆã‚Œã‚“ããã¯ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆlocalStorageï¼‰ã€‚</p>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button value="cancel">ã¨ã˜ã‚‹</button>
      </div>
    </form>
  </dialog>

  <script>
// ===== åˆæœŸå‚ç…§ =====
const $ = (s)=>document.querySelector(s);
const modeEl = $('#mode');
const danEl = $('#dan');
const readModeEl = $('#readMode');
const startBtn = $('#btnStart');
const speakBtn = $('#btnSpeak');
const singDanBtn = $('#btnSingDan');
const problemEl = $('#problem');
const answerEl = $('#answer');
const submitBtn = $('#btnSubmit');
const nextBtn = $('#btnNext');
const feedbackEl = $('#feedback');
const boardEl = $('#board');
const totalEl = $('#total');
const correctEl = $('#correct');
const wrongEl = $('#wrong');
const streakEl = $('#streak');
const bestEl = $('#best');
const progressEl = $('#progress');
const dlgHelp = document.getElementById('dlgHelp');
const btnHelp = document.getElementById('btnHelp');
const keypadEl = document.getElementById('keypad');

// ===== çŠ¶æ…‹ =====
let problems = [];
let idx = 0;
let correct = 0;
let wrong = 0;
let streak = 0;
let best = Number(localStorage.getItem('kuku_best_streak')||0);
if(bestEl) bestEl.textContent = best;

// ===== å‡ºé¡Œç”Ÿæˆ =====
function buildProblems(){
  const list=[];
  const dan = danEl.value;
  const mults = dan==='all' ? [...Array(9).keys()].map(i=>i+1) : [Number(dan)];
  for(const a of mults){ for(let b=1;b<=9;b++) list.push({a,b,done:false,miss:false}); }
  if(modeEl.value==='random') shuffle(list);
  return list;
}
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } }

// ===== ç”»é¢æç”» =====
function renderBoard(){
  boardEl.innerHTML='';
  problems.forEach((p)=>{
    const d=document.createElement('div');
    d.className='chip'+(p.done?' done':'')+(p.miss?' miss':'');
    d.textContent=`${p.a}Ã—${p.b}`;
    d.title = p.done? (p.miss? 'ã¾ã¡ãŒã„â†’æ­£è§£':'æ­£è§£'): 'ã¾ã ';
    boardEl.appendChild(d);
  });
}

// ===== éŸ³å£° =====
function speak(text, rate=1.0, pitch=1.0){
  try{
    if(!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang='ja-JP'; u.rate=rate; u.pitch=pitch; u.volume=1.0;
    const voices = speechSynthesis.getVoices();
    const jp = voices.find(v=>v.lang && v.lang.startsWith('ja'));
    if(jp) u.voice = jp;
    speechSynthesis.speak(u);
  }catch(e){ console.error(e); }
}

// ===== ä¹ä¹ã®æ­Œãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
const OLD_NUM = {1:'ã„ã¡',2:'ã«',3:'ã•ã‚“',4:'ã—',5:'ã”',6:'ã‚ã',7:'ã—ã¡',8:'ã¯ã¡',9:'ã'};
function numOld(n){
  if(n<=9) return OLD_NUM[n];
  const t = Math.floor(n/10), u = n%10;
  const ten = (t===1?'':(t===4?'ã—':t===7?'ã—ã¡':t===9?'ã':OLD_NUM[t])) + 'ã˜ã‚…ã†';
  return ten + (u? OLD_NUM[u] : '');
}
function phraseSong(a,b){ return `${OLD_NUM[a]}${OLD_NUM[b]}ãŒ${numOld(a*b)}`; }
function danSong(a){ const lines=[]; for(let b=1;b<=9;b++){ lines.push(phraseSong(a,b)); } return lines; }

// ===== å‡ºé¡Œåˆ¶å¾¡ =====
function current(){ return problems[idx]; }

function showProblem(){
  const p=current();
  if(!p){ finish(); return; }
  problemEl.textContent = `${p.a} Ã— ${p.b} = ï¼Ÿ`;
  answerEl.value='';
  // ãƒœã‚¿ãƒ³å…¥åŠ›å‰æ
  answerEl.readOnly = true;
  answerEl.disabled=false;
  submitBtn.disabled=false;
  nextBtn.disabled=true;
  answerEl.focus();
  if(readModeEl.value==='on')      speak(`${p.a} ã‹ã‘ã‚‹ ${p.b} ã¯ï¼Ÿ`, 0.98, 1.0);
  else if(readModeEl.value==='song') speak(phraseSong(p.a, p.b), 0.95, 1.05);
  totalEl.textContent = problems.length; correctEl.textContent = correct; wrongEl.textContent = wrong; streakEl.textContent = streak;
  progressEl.style.width = `${Math.round((idx)/problems.length*100)}%`;
}

function start(){
  correct=0; wrong=0; streak=0;
  problems = buildProblems(); idx = 0;
  feedbackEl.textContent='';
  renderBoard();
  showProblem();
}

function submit(){
  const p=current(); if(!p) return;
  const val = Number(answerEl.value);
  const ok = (p.a*p.b)===val;
  if(ok){
    correct++; streak++; p.done=true;
    feedbackEl.innerHTML = `âœ… æ­£è§£ï¼ <b>${p.a}Ã—${p.b}=${p.a*p.b}</b>`;
    if(streak>best){ best=streak; localStorage.setItem('kuku_best_streak',String(best)); bestEl.textContent=best; }
    renderBoard(); idx++;
    nextBtn.disabled=false; submitBtn.disabled=true; answerEl.disabled=true;
    setTimeout(()=>{ showProblem(); }, 450);
  }else{
    wrong++; streak=0; p.miss=true;
    feedbackEl.innerHTML = `âŒ ã¡ãŒã†ã‚ˆã€‚ã‚‚ã†ã„ã¡ã©ï¼`;
    if(readModeEl.value==='on') speak(`${p.a} ã‹ã‘ã‚‹ ${p.b} ã¯ï¼Ÿ`);
    if(readModeEl.value==='song') speak(phraseSong(p.a, p.b), 0.95, 1.05);
    renderBoard();
  }
  correctEl.textContent = correct; wrongEl.textContent = wrong; streakEl.textContent = streak;
  progressEl.style.width = `${Math.round((idx)/problems.length*100)}%`;
}

function next(){ if(idx>=problems.length){ finish(); return; } showProblem(); }

function finish(){
  problemEl.textContent = 'ãŠã¤ã‹ã‚Œã•ã¾ï¼ ãœã‚“ã¶ãŠã‚ã£ãŸã‚ˆ ğŸ‰';
  answerEl.disabled=true; submitBtn.disabled=true; nextBtn.disabled=true;
  progressEl.style.width = '100%';
  const rate = problems.length? Math.round(correct/problems.length*100):0;
  const stars = rate>=95? 'â˜…â˜…â˜…' : rate>=80? 'â˜…â˜…' : rate>=60? 'â˜…' : 'â€”';
  feedbackEl.innerHTML = `çµæœ: æ­£è§£ <b>${correct}</b> / ${problems.length}ï¼ˆæ­£ç­”ç‡ ${rate}%ï¼‰<br>ã‚¹ã‚¿ãƒ¼: <b>${stars}</b>`;
}

// ===== ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ï¼ˆæ•°å­—ãƒœã‚¿ãƒ³ï¼‰ =====
function appendDigit(d){ if(answerEl.disabled) return; answerEl.value = (answerEl.value||'') + String(d); }
function backspace(){ answerEl.value = (answerEl.value||'').slice(0,-1); }
function clearAns(){ answerEl.value=''; }
if(keypadEl){
  keypadEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(btn.hasAttribute('data-digit')){ appendDigit(btn.getAttribute('data-digit')); }
    else if(btn.getAttribute('data-action')==='back'){ backspace(); }
    else if(btn.getAttribute('data-action')==='clear'){ clearAns(); }
  });
}

// ===== ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² =====
startBtn.addEventListener('click', start);
submitBtn.addEventListener('click', submit);
nextBtn.addEventListener('click', next);
speakBtn.addEventListener('click', ()=>{ const p=current(); if(!p) return;
  if(readModeEl.value==='song') speak(phraseSong(p.a, p.b), 0.95, 1.05);
  else speak(`${p.a} ã‹ã‘ã‚‹ ${p.b} ã¯ï¼Ÿ`, 0.98, 1.0);
});
btnHelp.addEventListener('click', ()=> dlgHelp.showModal());
singDanBtn.addEventListener('click', ()=>{
  const val = danEl.value; if(val==='all'){ alert('ã€Œãœã‚“ã¶ã€ã§ã¯ ã ã‚“ã‚’æ­Œãˆã¾ã›ã‚“ã€‚1ã€œ9ã®ã ã‚“ã‚’ãˆã‚‰ã‚“ã§ã­'); return; }
  const a = Number(val); const lines = danSong(a);
  speak(lines.join('ã€') + 'ã€‚', 0.92, 1.05);
});

// Enterã§å›ç­”ã€Spaceã§æ¬¡ã¸ï¼ˆSpaceã¯æ¬¡ã¸ãƒœã‚¿ãƒ³æœ‰åŠ¹æ™‚ã®ã¿ï¼‰
answerEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); submit(); } });
window.addEventListener('keydown',(e)=>{ if(e.key===' ' || e.code==='Space'){ if(!nextBtn.disabled){ e.preventDefault(); next(); } } });

// iOS Safari ã® getVoices é…å»¶å¯¾ç­–
if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged = ()=>{} }
</script>
</body>
</html>
