<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ããã‚Œã‚“ã—ã‚…ã†</title>
  <style>
    :root{ --bg:#0b1020; --card:#111933; --acc:#4fa3ff; --ok:#22c55e; --bad:#ef4444; --text:#e9eefb; }
    *{box-sizing:border-box}
    body{margin:0;padding:16px 16px 40px;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN","Noto Sans JP",sans-serif}
    .container{max-width:980px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:clamp(20px,4vw,28px);margin:0}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.05),transparent 30%) ,var(--card);border:1px solid rgba(255,255,255,.08);padding:16px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{font-size:14px;opacity:.9}
    select,button,input[type="text"]{background:#0b1430;color:var(--text);border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:10px 12px;font-size:16px}
    button{cursor:pointer}
    button.primary{background:var(--acc);border-color:transparent;color:#001326;font-weight:700}
    button.lg{font-size:20px;padding:12px 16px;border-radius:14px}
    .controls{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.controls{grid-template-columns:1.2fr 1fr 1.1fr}}
    .problem{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;font-weight:800;font-size:clamp(22px,7vw,56px);min-height:130px}
    .correctMsg{font-size:24px;color:var(--ok);font-weight:700;min-height:1.2em}
    .hintText{font-size:20px;opacity:0.85;color:#ffd966;min-height:1.2em}
    .feedbackMsg{font-size:18px;margin-top:2px;min-height:1.2em}
    .answerWrap{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px;flex-wrap:wrap}
    .answerWrap input{font-size:clamp(20px,5vw,36px);width:8ch;text-align:center}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.15);border-radius:999px;padding:6px 10px;font-size:13px;opacity:.9}
    .status{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .bar{height:10px;background:#0b1430;border-radius:999px;overflow:hidden}
    .bar .fill{height:100%;background:linear-gradient(90deg,var(--acc),#8ef0ff);width:0%}
    .grid9{display:grid;grid-template-columns:repeat(9,1fr);gap:6px;margin-top:10px}
    .chip{background:#0b1430;border:1px solid rgba(255,255,255,.15);padding:8px;border-radius:10px;text-align:center}
    .chip.done{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.5)}
    .chip.miss{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.5)}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;max-width:360px;margin:16px auto}
    .keypad button{padding:20px 0;font-size:1.4em;border-radius:14px;touch-action:manipulation}
    .stats h2{margin:0 0 8px;font-size:20px}
    .stats .row{align-items:center}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(255,255,255,.12);padding:8px;text-align:left}
    th{opacity:.85;font-weight:700}
    .muted{opacity:.8}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#21305d;border:1px solid rgba(255,255,255,.15);font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ããã‚Œã‚“ã—ã‚…ã† <span class="pill">ğŸµ ã‚¦ã‚¿ãƒ¢ãƒ¼ãƒ‰</span></h1>
      <nav>
        <a href="soroban.html" class="pill">â— ãã‚ã°ã‚“ç·´ç¿’</a>
      </nav>
    </header>

    <section class="card controls" aria-label="ã›ã£ã¦ã„">
      <div class="row" style="align-items:end">
        <div>
          <label for="mode">ãƒ¢ãƒ¼ãƒ‰</label><br>
          <select id="mode" aria-label="ã—ã‚…ã¤ã ã„ãƒ¢ãƒ¼ãƒ‰">
            <option value="sequential">ã˜ã‚…ã‚“ã°ã‚“</option>
            <option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option>
            <option value="mistake">ã‚ˆãã¾ã¡ãŒãˆã‚‹</option>
          </select>
        </div>
        <div>
          <label for="dan">ã ã‚“</label><br>
          <select id="dan" aria-label="ãˆã‚‰ã¶ã ã‚“">
            <option value="all">ãœã‚“ã¶</option>
            <option value="1">1ã®ã ã‚“</option>
            <option value="2">2ã®ã ã‚“</option>
            <option value="3">3ã®ã ã‚“</option>
            <option value="4">4ã®ã ã‚“</option>
            <option value="5">5ã®ã ã‚“</option>
            <option value="6">6ã®ã ã‚“</option>
            <option value="7">7ã®ã ã‚“</option>
            <option value="8">8ã®ã ã‚“</option>
            <option value="9">9ã®ã ã‚“</option>
          </select>
        </div>
        <div class="row">
          <button id="btnStart" class="primary lg">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          <button id="btnSingOne" class="lg">ğŸµ ã“ã®ã‚‚ã‚“ã ã„ã‚’ã†ãŸã†</button>
          <button id="btnSingAll" class="lg">ğŸµ ã ã‚“ã‚’ãœã‚“ã¶ã†ãŸã†</button>
          <button id="btnStats" class="lg">ğŸ“Š ã¨ã†ã‘ã„</button>
        </div>
      </div>

      <div class="status" style="margin-top:6px">
        <div class="pill">ã‚‚ã‚“ã ã„ã™ã†: <span id="total">0</span> / ã›ã„ã‹ã„: <span id="correct">0</span> / ã¾ã¡ãŒã„: <span id="wrong">0</span> / ã‚Œã‚“ããã›ã„ã‹ã„: <span id="streak">0</span></div>
        <div class="pill">ãƒ™ã‚¹ãƒˆã‚Œã‚“ãã: <span id="best">0</span></div>
      </div>
      <div class="bar" aria-hidden="true"><div class="fill" id="progress"></div></div>
    </section>

    <section class="card" style="margin-top:14px">
      <div id="problem" class="problem" aria-live="polite" aria-atomic="true">
        <div id="correctMsg" class="correctMsg"></div>
        <div id="hintArea" class="hintText"></div>
        <div id="feedback" class="feedbackMsg"></div>
        <div id="questionText">ã‚¹ã‚¿ãƒ¼ãƒˆã‚’ãŠã—ã¦ã­</div>
      </div>
      <div class="answerWrap">
        <input id="answer" type="text" inputmode="none" placeholder="ã“ãŸãˆ" readonly disabled />
        <button id="btnSubmit" class="primary" disabled>ã“ãŸãˆã‚‹</button>
        <button id="btnGiveUp" disabled>ã‚ã‹ã‚‰ãªã„ï¼ˆÃ—ï¼‰</button>
        <button id="btnHint" disabled>ãƒ’ãƒ³ãƒˆï¼ˆã‚ˆã¿ï¼‰</button>
      </div>
      <div id="keypad" class="keypad" role="group" aria-label="ã™ã†ã˜ã‚­ãƒ¼">
        <button data-digit="1">1</button>
        <button data-digit="2">2</button>
        <button data-digit="3">3</button>
        <button data-digit="4">4</button>
        <button data-digit="5">5</button>
        <button data-digit="6">6</button>
        <button data-digit="7">7</button>
        <button data-digit="8">8</button>
        <button data-digit="9">9</button>
        <button data-action="clear">ã‚¯ãƒªã‚¢</button>
        <button data-digit="0">0</button>
        <button data-action="back">âŒ«</button>
      </div>
      <div id="board" class="grid9" aria-label="ã™ã™ã¿ãã‚ã„"></div>
    </section>

    <!-- ã¨ã†ã‘ã„ãƒ‘ãƒãƒ« -->
    <section id="statsPanel" class="card stats" style="display:none; margin-top:14px">
      <div class="row" style="justify-content:space-between">
        <h2>ğŸ“Š ã¨ã†ã‘ã„</h2>
        <div class="row">
          <button id="btnReset" class="ghost">ãƒªã‚»ãƒƒãƒˆ</button>
          <button id="btnCloseStats" class="ghost">ã¨ã˜ã‚‹</button>
        </div>
      </div>
      <div id="statsSummary" class="muted" style="margin-bottom:8px"></div>
      <div style="overflow:auto">
        <table id="statsTable">
          <thead>
            <tr><th>ã—ã</th><th>ã›ã„</th><th>ã”</th><th>ã›ã„ã¨ã†ã‚Šã¤</th><th>ã•ã„ãã‚“</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="statsHint" class="muted" style="margin-top:6px">
        ã€Œãƒ¢ãƒ¼ãƒ‰ã€ã§ <span class="tag">ã‚ˆãã¾ã¡ãŒãˆã‚‹</span> ã‚’ãˆã‚‰ã¶ã¨ã€ã“ã“ã§ã”ã¨ã†ãŒãŠãŠã„ã‚‚ã®ã‚’ã‚†ã†ã›ã‚“ã—ã¦ã—ã‚…ã¤ã ã„ã—ã¾ã™ã€‚
      </div>
    </section>

  </div>

  <script>
  // è¦ç´ å‚ç…§
  const $ = (s)=>document.querySelector(s);
  const modeEl=$('#mode'), danEl=$('#dan');
  const startBtn=$('#btnStart'), singOneBtn=$('#btnSingOne'), singAllBtn=$('#btnSingAll');
  const statsBtn=$('#btnStats'), statsPanel=$('#statsPanel'), closeStatsBtn=$('#btnCloseStats'), resetBtn=$('#btnReset');
  const questionEl=$('#questionText'), answerEl=$('#answer'), submitBtn=$('#btnSubmit');
  const giveUpBtn=$('#btnGiveUp'), hintBtn=$('#btnHint');
  const feedbackEl=$('#feedback'), hintArea=$('#hintArea'), boardEl=$('#board'), correctMsgEl=$('#correctMsg');
  const totalEl=$('#total'), correctEl=$('#correct'), wrongEl=$('#wrong'), streakEl=$('#streak'), bestEl=$('#best'), progressEl=$('#progress');
  const keypadEl=$('#keypad');

  // è¨˜éŒ²ï¼ˆlocalStorageï¼‰
  const STATS_KEY='kuku_stats_v1';
  function loadStats(){
    try{ return JSON.parse(localStorage.getItem(STATS_KEY)||'{}'); }catch(e){ return {}; }
  }
  function saveStats(s){ try{ localStorage.setItem(STATS_KEY, JSON.stringify(s)); }catch(e){} }
  function bumpStat(a,b,ok){
    const id=`${a}x${b}`; const s=loadStats();
    if(!s[id]) s[id]={correct:0,wrong:0,last:0};
    if(ok) s[id].correct++; else s[id].wrong++;
    s[id].last=Date.now();
    saveStats(s);
  }

  // å‡ºé¡Œ
  let problems=[], idx=0, correct=0, wrong=0, streak=0;
  let best=Number(localStorage.getItem('kuku_best_streak')||0);
  bestEl.textContent=best;

  function buildProblems(){
    const list=[]; const dan=danEl.value; const stats=loadStats();
    const mults = (dan==='all') ? [...Array(9).keys()].map(i=>i+1) : [Number(dan)];

    if(modeEl.value==='mistake'){
      // èª¤ç­”ã®å¤šã„ãƒ»æ­£ç­”ç‡ãŒä½ã„ã‚‚ã®ã‚’å„ªå…ˆ
      const pool=[];
      for(const a of mults){ for(let b=1;b<=9;b++){
        const id=`${a}x${b}`; const rec=stats[id]||{correct:0,wrong:0};
        const tries=rec.correct+rec.wrong; const errRate = tries? rec.wrong/tries : 0;
        const weight = Math.max(1, Math.round(rec.wrong*2 + errRate*5));
        if(rec.wrong>0 || tries===0){ for(let k=0;k<weight;k++) pool.push({a,b,done:false,miss:false}); }
      }}
      if(pool.length){ shuffle(pool); return pool.slice(0,45); }
      // è¨˜éŒ²ãŒãªã„ï¼é–“é•ã„ãŒãªã„ â†’ é€šå¸¸ã«æˆ»ã™
    }

    for(const a of mults){ for(let b=1;b<=9;b++) list.push({a,b,done:false,miss:false}); }
    if(modeEl.value==='random') shuffle(list);
    return list;
  }
  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [arr[i],arr[j]]=[arr[j],arr[i]]; } }

  function renderBoard(){
    boardEl.innerHTML='';
    problems.forEach(p=>{
      const d=document.createElement('div');
      d.className='chip'+(p.done?' done':'')+(p.miss?' miss':'');
      d.textContent=`${p.a}Ã—${p.b}`;
      d.title = p.done? (p.miss? 'ã¾ã¡ãŒã„â†’ã›ã„ã‹ã„':'ã›ã„ã‹ã„'): 'ã¾ã ';
      boardEl.appendChild(d);
    });
  }

  // ããã®ã†ãŸï¼ˆãƒ•ãƒ¬ãƒ¼ã‚ºï¼‰
  const CHANT = { '1x1':'ã„ã‚“ã„ã¡ãŒã„ã¡','1x2':'ã„ã‚“ã«ãŒã«','1x3':'ã„ã‚“ã•ã‚“ãŒã•ã‚“','1x4':'ã„ã‚“ã—ãŒã—','1x5':'ã„ã‚“ã”ãŒã”','1x6':'ã„ã‚“ã‚ããŒã‚ã','1x7':'ã„ã‚“ã—ã¡ãŒã—ã¡','1x8':'ã„ã‚“ã¯ã¡ãŒã¯ã¡','1x9':'ã„ã‚“ããŒã',
    '2x1':'ã«ã„ã¡ãŒã«','2x2':'ã«ã«ã‚“ãŒã—','2x3':'ã«ã•ã‚“ãŒã‚ã','2x4':'ã«ã—ãŒã¯ã¡','2x5':'ã«ã”ã˜ã‚…ã†','2x6':'ã«ã‚ãã˜ã‚…ã†ã«','2x7':'ã«ã—ã¡ã˜ã‚…ã†ã—','2x8':'ã«ã¯ã¡ã˜ã‚…ã†ã‚ã','2x9':'ã«ãã˜ã‚…ã†ã¯ã¡',
    '3x1':'ã•ã‚“ã„ã¡ãŒã•ã‚“','3x2':'ã•ã‚“ã«ãŒã‚ã','3x3':'ã•ã–ã‚“ãŒã','3x4':'ã•ã‚“ã—ã˜ã‚…ã†ã«','3x5':'ã•ã‚“ã”ã˜ã‚…ã†ã”','3x6':'ã•ã¶ã‚ãã˜ã‚…ã†ã¯ã¡','3x7':'ã•ã‚“ã—ã¡ã«ã˜ã‚…ã†ã„ã¡','3x8':'ã•ã‚“ã±ã«ã˜ã‚…ã†ã—','3x9':'ã•ã‚“ãã«ã˜ã‚…ã†ã—ã¡',
    '4x1':'ã—ã„ã¡ãŒã—','4x2':'ã—ã«ãŒã¯ã¡','4x3':'ã—ã•ã‚“ã˜ã‚…ã†ã«','4x4':'ã—ã—ã˜ã‚…ã†ã‚ã','4x5':'ã—ã”ã«ã˜ã‚…ã†','4x6':'ã—ã‚ãã«ã˜ã‚…ã†ã—','4x7':'ã—ã—ã¡ã«ã˜ã‚…ã†ã¯ã¡','4x8':'ã—ã¯ã•ã‚“ã˜ã‚…ã†ã«','4x9':'ã—ãã•ã‚“ã˜ã‚…ã†ã‚ã',
    '5x1':'ã”ã„ã¡ãŒã”','5x2':'ã”ã«ã˜ã‚…ã†','5x3':'ã”ã•ã‚“ã˜ã‚…ã†ã”','5x4':'ã”ã—ã«ã˜ã‚…ã†','5x5':'ã”ã”ã«ã˜ã‚…ã†ã”','5x6':'ã”ã‚ãã•ã‚“ã˜ã‚…ã†','5x7':'ã”ã—ã¡ã•ã‚“ã˜ã‚…ã†ã”','5x8':'ã”ã¯ã—ã˜ã‚…ã†','5x9':'ã”ã£ãã—ã˜ã‚…ã†ã”',
    '6x1':'ã‚ãã„ã¡ãŒã‚ã','6x2':'ã‚ãã«ã˜ã‚…ã†ã«','6x3':'ã‚ãã•ã‚“ã˜ã‚…ã†ã¯ã¡','6x4':'ã‚ãã—ã«ã˜ã‚…ã†ã—','6x5':'ã‚ãã”ã•ã‚“ã˜ã‚…ã†','6x6':'ã‚ãã‚ãã•ã‚“ã˜ã‚…ã†ã‚ã','6x7':'ã‚ãã—ã¡ã—ã˜ã‚…ã†ã«','6x8':'ã‚ãã¯ã—ã˜ã‚…ã†ã¯ã¡','6x9':'ã‚ã£ãã”ã˜ã‚…ã†ã—',
    '7x1':'ã—ã¡ã„ã¡ãŒã—ã¡','7x2':'ã—ã¡ã«ã˜ã‚…ã†ã—','7x3':'ã—ã¡ã•ã‚“ã«ã˜ã‚…ã†ã„ã¡','7x4':'ã—ã¡ã—ã«ã˜ã‚…ã†ã¯ã¡','7x5':'ã—ã¡ã”ã•ã‚“ã˜ã‚…ã†ã”','7x6':'ã—ã¡ã‚ãã—ã˜ã‚…ã†ã«','7x7':'ã—ã¡ã—ã¡ã—ã˜ã‚…ã†ã','7x8':'ã—ã¡ã¯ã”ã˜ã‚…ã†ã‚ã','7x9':'ã—ã¡ãã‚ãã˜ã‚…ã†ã•ã‚“',
    '8x1':'ã¯ã¡ã„ã¡ãŒã¯ã¡','8x2':'ã¯ã¡ã«ã˜ã‚…ã†ã‚ã','8x3':'ã¯ã¡ã•ã‚“ã«ã˜ã‚…ã†ã—','8x4':'ã¯ã¡ã—ã•ã‚“ã˜ã‚…ã†ã«','8x5':'ã¯ã¡ã”ã—ã˜ã‚…ã†','8x6':'ã¯ã¡ã‚ãã—ã˜ã‚…ã†ã¯ã¡','8x7':'ã¯ã¡ã—ã¡ã”ã˜ã‚…ã†ã‚ã','8x8':'ã¯ã£ã±ã‚ãã˜ã‚…ã†ã—','8x9':'ã¯ã£ãã—ã¡ã˜ã‚…ã†ã«',
    '9x1':'ãã„ã¡ãŒã','9x2':'ãã«ã˜ã‚…ã†ã¯ã¡','9x3':'ãã•ã‚“ã«ã˜ã‚…ã†ã—ã¡','9x4':'ãã—ã•ã‚“ã˜ã‚…ã†ã‚ã','9x5':'ãã”ã—ã˜ã‚…ã†ã”','9x6':'ãã‚ãã”ã˜ã‚…ã†ã—','9x7':'ãã—ã¡ã‚ãã˜ã‚…ã†ã•ã‚“','9x8':'ãã¯ã—ã¡ã˜ã‚…ã†ã«','9x9':'ããã¯ã¡ã˜ã‚…ã†ã„ã¡'};

  // ç­”ãˆå´ï¼ˆåãƒ»ä¸€ã®èª­ã¿ï¼‰
  const OLD_NUM={1:'ã„ã¡',2:'ã«',3:'ã•ã‚“',4:'ã—',5:'ã”',6:'ã‚ã',7:'ã—ã¡',8:'ã¯ã¡',9:'ã'};
  function numSong(n){ if(n<=9) return OLD_NUM[n]; const t=Math.floor(n/10), u=n%10; const ten=(t===1?'':(t===4?'ã—':(t===7?'ã—ã¡':(t===9?'ã':OLD_NUM[t]))))+'ã˜ã‚…ã†'; return ten + (u? OLD_NUM[u] : ''); }
  function phraseSong(a,b){ return CHANT[`${a}x${b}`] || `${a}Ã—${b}`; }
  function danSong(a){ const lines=[]; for(let b=1;b<=9;b++){ lines.push(phraseSong(a,b)); } return lines; }

  // éŸ³å£°ï¼ˆæ­Œã†ï¼‰
  function speak(text, rate=0.98, pitch=1.03){ try{ if(!('speechSynthesis' in window)) return; window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text); u.lang='ja-JP'; u.rate=rate; u.pitch=pitch; u.volume=1.0; const vs = speechSynthesis.getVoices(); const jp = vs.find(v=>v.lang && v.lang.startsWith('ja')); if(jp) u.voice = jp; speechSynthesis.speak(u); }catch(e){ console.error(e); } }

  // è¡¨ç¤ºåˆ¶å¾¡
  function current(){ return problems[idx]; }

  function showProblem(){
    const p=current();
    if(!p){ finish(); return; }
    correctMsgEl.textContent='';
    feedbackEl.textContent='';
    questionEl.textContent = `${p.a} Ã— ${p.b} = ï¼Ÿ`;
    answerEl.value='';
    answerEl.readOnly = true;
    answerEl.disabled=false; submitBtn.disabled=false; giveUpBtn.disabled=false; hintBtn.disabled=false;
    hintArea.textContent='';
    totalEl.textContent = problems.length; correctEl.textContent = correct; wrongEl.textContent = wrong; streakEl.textContent = streak;
    progressEl.style.width = `${Math.round((idx)/problems.length*100)}%`;
  }

  function start(){
    correct=0; wrong=0; streak=0; idx=0;
    feedbackEl.textContent=''; correctMsgEl.textContent='';
    problems = buildProblems();
    renderBoard();
    showProblem();
  }

  function submit(){
    const p=current(); if(!p) return;
    const val = Number(answerEl.value);
    const ok = (p.a*p.b)===val;
    bumpStat(p.a,p.b,ok);
    if(ok){
      correct++; streak++; p.done=true;
      correctMsgEl.textContent = 'ã›ã„ã‹ã„ï¼';
      feedbackEl.innerHTML = `âœ… ã›ã„ã‹ã„ï¼ <b>${p.a}Ã—${p.b}=${p.a*p.b}</b>`;
      if(streak>best){ best=streak; localStorage.setItem('kuku_best_streak', String(best)); bestEl.textContent = best; }
      renderBoard(); idx++;
      submitBtn.disabled=true; answerEl.disabled=true;
      setTimeout(showProblem, 450);
    }else{
      wrong++; streak=0; p.miss=true;
      correctMsgEl.textContent='';
      feedbackEl.textContent = 'âŒ ã¡ãŒã†ã‚ˆã€‚ã‚‚ã†ã„ã¡ã©ï¼';
      renderBoard();
    }
    correctEl.textContent = correct; wrongEl.textContent = wrong; streakEl.textContent = streak;
    progressEl.style.width = `${Math.round((idx)/problems.length*100)}%`;
  }

  function giveUp(){
    const p=current(); if(!p) return;
    bumpStat(p.a,p.b,false);
    wrong++; streak=0; p.miss=true; renderBoard(); idx++;
    hintArea.textContent=''; correctMsgEl.textContent='';
    showProblem();
    wrongEl.textContent = wrong; streakEl.textContent = streak;
  }

  function finish(){
    questionEl.textContent = 'ãŠã¤ã‹ã‚Œã•ã¾ï¼ ãœã‚“ã¶ãŠã‚ã£ãŸã‚ˆ ğŸ‰';
    answerEl.disabled=true; submitBtn.disabled=true; giveUpBtn.disabled=true; hintBtn.disabled=true;
    progressEl.style.width = '100%';
    const rate = problems.length? Math.round(correct/problems.length*100):0;
    const stars = rate>=95? 'â˜…â˜…â˜…' : rate>=80? 'â˜…â˜…' : rate>=60? 'â˜…' : 'â€”';
    feedbackEl.innerHTML = `ã‘ã£ã‹: ã›ã„ã‹ã„ <b>${correct}</b> / ${problems.length}ï¼ˆã›ã„ã¨ã†ã‚Šã¤ ${rate}%ï¼‰<br>ã™ãŸãƒ¼: <b>${stars}</b>`;
  }

  // ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰
  function appendDigit(d){ if(answerEl.disabled) return; answerEl.value = (answerEl.value||'') + String(d); }
  function backspace(){ answerEl.value = (answerEl.value||'').slice(0,-1); }
  function clearAns(){ answerEl.value=''; }
  keypadEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(btn.hasAttribute('data-digit')){ appendDigit(btn.getAttribute('data-digit')); }
    else if(btn.getAttribute('data-action')==='back'){ backspace(); }
    else if(btn.getAttribute('data-action')==='clear'){ clearAns(); }
  });

  // ãƒ’ãƒ³ãƒˆ & ã†ãŸ
  hintBtn.addEventListener('click', ()=>{
    const p=current(); if(!p) return;
    const full = phraseSong(p.a,p.b);
    const prod = numSong(p.a*p.b);
    const hint = full.endsWith(prod) ? full.slice(0, full.length - prod.length) : full; // æœ«å°¾ã®ç­”ãˆèª­ã¿ã‚’é™¤å»
    hintArea.textContent = hint; // ä¾‹: ã€Œã«ã«ã‚“ãŒã€
  });
  singOneBtn.addEventListener('click', ()=>{ const p=current(); if(!p) return; speak( phraseSong(p.a,p.b), 0.95, 1.05 ); });
  singAllBtn.addEventListener('click', ()=>{
    const val = danEl.value; if(val==='all'){ alert('ã€Œãœã‚“ã¶ã€ã§ã¯ ã ã‚“ã‚’ãœã‚“ã¶ã†ãŸãˆã¾ã›ã‚“ã€‚1ã€œ9ã®ã ã‚“ã‚’ãˆã‚‰ã‚“ã§ã­'); return; }
    const a = Number(val); const lines = danSong(a);
    speak(lines.join('ã€')+'ã€‚', 0.92, 1.05);
  });

  // ã¨ã†ã‘ã„ãƒ‘ãƒãƒ«
  function formatDate(ts){ if(!ts) return '-'; const d=new Date(ts); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}/${z(d.getMonth()+1)}/${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`; }
  function openStats(){ statsPanel.style.display='block'; renderStats(); }
  function closeStats(){ statsPanel.style.display='none'; }
  function resetStats(){ if(confirm('ãã‚ãã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){ localStorage.removeItem(STATS_KEY); renderStats(); } }

  function renderStats(){
    const s=loadStats();
    const rows=[]; let totC=0, totW=0;
    for(const id in s){ const {correct,wrong,last}=s[id]; rows.push({id,correct,wrong,last}); totC+=correct; totW+=wrong; }
    rows.sort((a,b)=>{
      const ta=a.correct+a.wrong, tb=b.correct+b.wrong;
      const ra=ta? a.wrong/ta : 1, rb=tb? b.wrong/tb : 1;
      return (rb-ra)||((tb)-(ta))|| (b.wrong-a.wrong);
    });
    const tbody=$('#statsTable tbody'); tbody.innerHTML='';
    rows.slice(0,60).forEach(r=>{
      const tr=document.createElement('tr');
      const rate=(r.correct+r.wrong)? Math.round(r.correct/(r.correct+r.wrong)*100) : 0;
      tr.innerHTML=`<td>${r.id.replace('x','Ã—')}</td><td>${r.correct}</td><td>${r.wrong}</td><td>${rate}%</td><td>${formatDate(r.last)}</td>`;
      tbody.appendChild(tr);
    });
    const tries=totC+totW; const acc = tries? Math.round(totC/tries*100):0;
    $('#statsSummary').innerHTML = `ã”ã†ã‘ã„: ã›ã„ <b>${totC}</b> / ã” <b>${totW}</b>ï¼ˆã›ã„ã¨ã†ã‚Šã¤ <b>${acc}%</b>ï¼‰ ãƒ» ãƒ™ã‚¹ãƒˆã‚Œã‚“ãã <b>${best}</b>`;
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  startBtn.addEventListener('click', start);
  submitBtn.addEventListener('click', submit);
  giveUpBtn.addEventListener('click', giveUp);
  statsBtn.addEventListener('click', openStats);
  closeStatsBtn.addEventListener('click', closeStats);
  resetBtn.addEventListener('click', resetStats);

  // iOS Safari ã® getVoices é…å»¶å¯¾ç­–ï¼ˆå‰¯ä½œç”¨ãªã—ï¼‰
  if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged = ()=>{}; }
  </script>
</body>
</html>
